# Phase 02: 3D Asset Preparation

**Priority:** P1
**Status:** Pending
**Effort:** 2h
**Dependencies:** Phase 01 complete

---

## Context Links

- [Research: Model Viewer Comparison](/Users/mbpprm/Documents/mybuild/for-sale/shopify01/plans/reports/researcher-260202-2313-3d-model-viewer-comparison.md)
- [Phase 01 Analysis](/Users/mbpprm/Documents/mybuild/for-sale/shopify01/plans/260202-2331-3d-product-viewer/phase-01-setup-analysis.md)

---

## Overview

Optimize GLB files to meet performance targets (<5MB, <50k polygons), create fallback images, prepare USDZ for iOS AR, test file loading.

---

## Key Insights

- **Target size:** <5MB GLB (Shopify recommended), <15MB max
- **Polygon budget:** <50k for 30+ FPS on mobile
- **Texture limit:** 2048x2048px (1024x1024 for mobile-first)
- **Compression:** Draco compression only if savings >100KB
- **Format:** GLB preferred (single file), USDZ for iOS AR

---

## Requirements

### Functional
- [ ] GLB files optimized to <5MB
- [ ] Polygon count <50k per model
- [ ] Textures compressed and sized appropriately
- [ ] Fallback preview images created (1200x1200px)
- [ ] USDZ files generated for iOS AR

### Non-Functional
- [ ] Visual quality maintained during optimization
- [ ] Load time <3s on 4G connection
- [ ] File naming convention consistent
- [ ] Assets organized for easy Shopify upload

---

## Architecture

### Asset Structure
```
3D Assets/
├── product-model.glb           # Optimized GLB (<5MB)
├── product-model.usdz          # iOS AR version
├── product-model-preview.jpg   # Fallback image (1200x1200)
├── product-model-poster.jpg    # Loading poster (800x800)
└── optimization-report.txt     # Details on optimization
```

### Optimization Pipeline
```
Source GLB → Polygon Reduction → Texture Optimization → Draco Compression → Final GLB
             (decimation)          (resize/compress)      (if needed)         (<5MB)
```

---

## Related Code Files

### Assets to Create
- Optimized GLB files (uploaded to Shopify Media API)
- Preview images (JPG, 1200x1200px, <200KB)
- Poster images (JPG, 800x800px, <100KB)
- USDZ files (auto-generated by Shopify or manual conversion)

### Tools Needed
- Blender (mesh optimization, texture baking)
- glTF-Transform (CLI optimization tool)
- Draco encoder (geometry compression)
- Image optimization (ImageMagick, Squoosh)

---

## Implementation Steps

### 1. Analyze Source 3D Models
```bash
# Check GLB file size and complexity
npx gltf-transform inspect model.glb

# Expected output:
# - Polygon count
# - Texture sizes
# - Material count
# - File size breakdown
```

### 2. Optimize Mesh (Polygon Reduction)
**If polygon count >50k:**

**Using Blender:**
```python
# Blender Python script for decimation
import bpy

obj = bpy.context.active_object
modifier = obj.modifiers.new("Decimate", 'DECIMATE')
modifier.ratio = 0.5  # Reduce to 50% polygons
bpy.ops.object.modifier_apply(modifier=modifier.name)
```

**Using glTF-Transform:**
```bash
npx gltf-transform optimize model.glb optimized-model.glb \
  --simplify \
  --ratio 0.5 \
  --error 0.001
```

**Target:** <50k polygons while maintaining visual quality

### 3. Optimize Textures
```bash
# Resize textures to 2048x2048 (or 1024 for mobile-first)
npx gltf-transform resize optimized-model.glb resized-model.glb \
  --width 2048 \
  --height 2048

# Convert to JPEG for color maps (smaller than PNG)
# Use PNG only for textures with alpha channel
```

**Texture Checklist:**
- [ ] Base color maps ≤2048x2048px (JPEG 80% quality)
- [ ] Normal maps ≤2048x2048px (PNG or JPEG)
- [ ] Roughness/Metallic ≤1024x1024px (can be smaller)
- [ ] Remove unused textures

### 4. Apply Draco Compression (If Needed)
```bash
# Only if file still >5MB after mesh/texture optimization
npx gltf-transform draco resized-model.glb final-model.glb

# Check final size
ls -lh final-model.glb
```

**Note:** Draco adds 100KB decoder overhead, only use if compression saves >200KB

### 5. Create Fallback Images
```bash
# Render high-quality preview from Blender or online tool
# Dimensions: 1200x1200px, JPG 85% quality

# Create poster image (loading state)
# Dimensions: 800x800px, JPG 75% quality

# Optimize images
convert preview.jpg -quality 85 -resize 1200x1200 product-model-preview.jpg
convert poster.jpg -quality 75 -resize 800x800 product-model-poster.jpg
```

### 6. Generate USDZ for iOS AR
**Option A:** Use Shopify auto-conversion (preferred)
- Shopify auto-generates USDZ when GLB uploaded
- No manual action needed

**Option B:** Manual conversion
```bash
# Using Reality Converter (macOS only)
# or online tool: https://products.pixyz-software.com/review/

# Export from Blender with USD format
# Convert GLB → USDZ via command line tool
```

### 7. Test Asset Loading
```bash
# Test GLB in browser
# Open https://modelviewer.dev/editor/
# Drop GLB file, verify:
# - Loads in <3s on throttled 4G
# - No missing textures
# - Smooth rotation at 30+ FPS
```

### 8. Document Optimization Results
Create optimization report:
```
Original: 12.3MB, 120k polygons
Optimized: 4.2MB, 48k polygons

Optimizations applied:
- Mesh decimation (60% reduction)
- Texture resize (4096 → 2048)
- Draco compression (1.8MB saved)
- Removed unused materials

Performance: 35 FPS on iPhone 12 simulator
Load time: 2.1s on Fast 3G
```

---

## Todo List

- [ ] Install optimization tools (Blender, glTF-Transform)
- [ ] Analyze source GLB files (inspect polygons, textures, size)
- [ ] Reduce polygon count to <50k if needed
- [ ] Resize textures to 2048x2048 or smaller
- [ ] Apply Draco compression if file >5MB
- [ ] Verify final GLB size <5MB
- [ ] Create preview image (1200x1200px, <200KB)
- [ ] Create poster image (800x800px, <100KB)
- [ ] Test GLB in model-viewer editor
- [ ] Verify USDZ generation (Shopify auto or manual)
- [ ] Test load time on throttled connection
- [ ] Test rendering on mobile browser
- [ ] Document optimization process in report
- [ ] Organize assets for Shopify upload

---

## Success Criteria

✅ GLB files <5MB each
✅ Polygon count <50k per model
✅ Textures ≤2048x2048px
✅ Load time <3s on Fast 3G
✅ 30+ FPS on iPhone 12/Galaxy A52
✅ Preview images created (<200KB)
✅ USDZ available for iOS AR
✅ Visual quality maintained (no obvious artifacts)
✅ Optimization report documented

---

## Risk Assessment

**Medium Risk** - Optimization may degrade visual quality

**Potential Issues:**
- Over-optimization → Loss of product detail
- Texture artifacts → Use conservative JPEG quality (85%)
- Draco compression issues → Test thoroughly before applying
- Missing source files → Need high-quality source models

**Mitigation:**
- Test optimization incrementally (mesh → texture → compression)
- Compare before/after in model-viewer editor
- Keep original files as backup
- Get client approval on visual quality
- Test on multiple devices before finalizing

---

## Security Considerations

**File Upload:**
- Verify GLB files don't contain embedded scripts
- Scan textures for malicious payloads (unlikely but check)
- Use Shopify Media API (trusted CDN)

**Privacy:**
- Ensure 3D models don't contain client proprietary info in metadata
- Strip camera paths, scene data from Blender exports

---

## Next Steps

After assets prepared:
→ **Phase 03:** Upload to Shopify, integrate with product-media.liquid
→ Test assets on staging store
→ Begin custom control implementation
